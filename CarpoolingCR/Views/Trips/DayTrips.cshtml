@model CarpoolingCR.Objects.Responses.TripDayTripsResponse

@{
    ViewBag.Title = "MonthTrips";
}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<div class="form-group">
    <h2>Viajes Disponibles</h2>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <br />
    <label class="control-label">@ViewBag.Info</label>

    <input id="AvailableSpaces" type="hidden" value="" />

    <div class="row form-group">
        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-2">
            @Html.ActionLink("<<", "Transportation", "Reservations", new { from = @Model.From, to = @Model.To }, new { @class = "btn btn-primary" })
        </div>
        <div class="col-lg-10 col-md-10 col-sm-10 col-xs-10">
            <label class="control-label" style="text-align:left">Trayecto: </label>  @Model.From -> @Model.To
        </div>
    </div>
    <hr />
    <div class="row form-group">
        <div id="dayCalendar" style="height:100%" class="col-lg-12 col-md-12 col-sm-12 col-xs-12">

        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="dayTripModal" tabindex="-1" role="dialog" aria-labelledby="dayTripModalLabel" aria-hidden="true">
    <form action="/Reservations/Create" method="post">
        <div class="vertical-alignment-helper">
            <div class="modal-dialog vertical-align-center">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">
                            <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>

                        </button>
                        <h4 class="modal-title" id="dayTripModalLabel">Reserva tu viaje</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row form-group">
                            <div class="col-lg-2 col-md-2 col-sm-2 col-xs-2">
                                <b>Trayecto</b>
                            </div>
                            <div class="col-lg-10 col-md-10 col-sm-10 col-xs-10">
                                <small id="modelFromTo"></small>
                            </div>
                        </div>
                        <div class="row form-group">
                            <div class="col-lg-2 col-md-2 col-sm-2 col-xs-6">
                                <b>Conductor</b>
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-6">
                                <small id="modelDriver"></small>
                            </div>
                            <div class="col-lg-2 col-md-2 col-sm-2 col-xs-6">
                                <b>Fecha</b>
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-6">
                                <small id="modelDate"></small>
                                <input type="text" id="ReservationDate" name="ReservationDate" class="hidden" />
                            </div>
                        </div>
                        <div class="row form-group">
                            <div class="col-lg-2 col-md-2 col-sm-2 col-xs-6">
                                <b>Espacios</b>
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-6">
                                <input id="RequestedSpaces" name="RequestedSpaces" class="" style="width:40px;" onfocus="blur();">
                                <input type="text" id="TripId" name="TripId" class="hidden" />
                            </div>
                            <div class="col-lg-2 col-md-2 col-sm-2 col-xs-6">
                                <b>Precio</b>
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-6">
                                ₡<small id="modelPrice"></small>
                            </div>
                        </div>
                        <div class="row form-group">
                            <div class="col-lg-2 col-md-2 col-sm-2 col-xs-6">
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-6">
                            </div>
                            <div class="col-lg-2 col-md-2 col-sm-2 col-xs-6">
                                <b>Total</b>
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-6">
                                ₡<small id="modelTotal"></small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Reservar</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<link href="~/fonts/fullcalendar-3.10.0/fullcalendar.min.css" rel="stylesheet" />
<script src="~/fonts/fullcalendar-3.10.0/moment.min.js"></script>
<script src="~/fonts/fullcalendar-3.10.0/fullcalendar.min.js"></script>
<script>
    $(document).ready(function () {
        var currentDate = new Date('@Model.CurrentDate');

        // page is now ready, initialize the calendar...
        $('#dayCalendar').fullCalendar({
            weekends: true,
            monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
            monthNamesShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
            dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
            dayNamesShort: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
            defaultView: 'agendaDay',
            eventLimit: true, // for all non-agenda views
            header: {
                left: 'title',
                center: '',
                right: ''
            },
            allDaySlot: false,
            contentHeight: "auto",
            eventTextColor: 'black',
            views: {
                timelineDay: {
                    selectable: true
                }
            },
            events: [],
            eventClick: function (calEvent, jsEvent, view) {
                var date = new Date(calEvent.formatteddate);
                var crStr = date.toLocaleString('es-CR', { year: "numeric", month: "2-digit", day: "numeric", hour: "2-digit", minute: "2-digit", hour12: true });
                var usStr = date.toLocaleString('en-US', { year: "numeric", month: "2-digit", day: "numeric", hour: "2-digit", minute: "2-digit", hour12: true });

                $("#dialog").dialog("open");
                $('#ui-id-1').html("Reserva tu viaje");
                $('#modelFromTo').html(calEvent.fromto);
                $('#modelDate').html(crStr);
                $('#ReservationDate').val(calEvent.formatteddate);
                $('#modelDriver').html(calEvent.driver);
                $('#AvailableSpaces').val(calEvent.availableSpaces);
                $('#modelPrice').html(calEvent.price);
                $('#modelTotal').html(calEvent.price);
                $('#TripId').val(calEvent.id);
                $("#dayTripModal").modal();
                //window.location.href = '/Reservations/Create?tripId=' + calEvent.id;
            }
        });

        var arrayOfTrips = JSON.parse('@Html.Raw(Json.Encode(Model.Trips))');

        for (var i = 0; i < arrayOfTrips.length; i++) {
            var tripId = arrayOfTrips[i].TripId;
            var availableSpaces = arrayOfTrips[i].AvailableSpaces;
            var dateTime = arrayOfTrips[i].DateTimeStr;
            var driver = arrayOfTrips[i].ApplicationUser.Name + ' ' + arrayOfTrips[i].ApplicationUser.LastName;
            var price = arrayOfTrips[i].Price;
            var from = arrayOfTrips[i].FromTown;
            var to = arrayOfTrips[i].ToTown;

            var startDate = new Date(dateTime);
            //enddate is 30 mins more than startdate, getTime is in milliseconds so 30 mins will be 30*60*100 = 1,800,000 millisecods
            var endDate = new Date(startDate.getTime() + 1800000);

            var event = {
                id: tripId,
                title: availableSpaces + ' espacios. ₡' + price.toFixed(2),
                start: startDate, end: endDate,
                color: '#2792F2',
                fromto: from + ' -> ' + to,
                driver: driver,
                availableSpaces: availableSpaces,
                formatteddate: dateTime,
                price: price.toFixed(2)
            };

            $('#dayCalendar').fullCalendar('renderEvent', event, true);
        }
        
        $('#dayCalendar').fullCalendar('gotoDate', startDate)
    });

    $('#RequestedSpaces').spinner({
        stop: function (e, ui) {
            var price = parseFloat($('#modelPrice').html());
            var requestedSpaces = parseInt($('#RequestedSpaces').val());

            var total = price * requestedSpaces;

            $('#modelTotal').html(total.toFixed(2));
        },
        min: 1,
        max: $('#AvailableSpaces').val()
    }).val(1);
</script>
